# 从 Clerk 迁移到 NextAuth 的方案

## 概述
将项目的鉴权系统从 Clerk 切换到 NextAuth，项目已包含 NextAuth 的基础代码，只需激活并替换 Clerk 相关代码。

## 修改步骤

### 1. 更新 packages/auth 包
- 修改 `packages/auth/index.ts`，将 `getCurrentUser` 从使用 Clerk 改为使用 NextAuth 的 `getServerSession`
- 删除 `packages/auth/clerk.ts`（或保留但不使用）
- 更新 `authOptions` 配置，确保正确指向 NextAuth 路由

### 2. 更新 tRPC 集成
- 修改 `packages/api/src/trpc.ts`，将 Clerk 的 `auth()` 改为 NextAuth 的 `getServerSession`
- 更新 `createTRPCContext` 函数，使用 NextAuth 的 session 数据

### 3. 更新 Next.js 应用层
- 修改 `apps/nextjs/src/middleware.ts`，从 Clerk middleware 切换到 NextAuth middleware（已有 `utils/nextauth.ts`）
- 修改 `apps/nextjs/src/trpc/server.ts`，将 Clerk 的 `auth()` 改为 NextAuth 的 `getServerSession`
- 修改 `apps/nextjs/src/app/api/trpc/edge/[trpc]/route.ts`，将 Clerk 的 `getAuth` 改为 NextAuth

### 4. 更新 Root Layout
- 修改 `apps/nextjs/src/app/layout.tsx`，移除 `ClerkProvider`，改用 `SessionProvider`（如果需要）

### 5. 更新 UI 组件
- 修改 `apps/nextjs/src/components/user-account-nav.tsx`，将 `useClerk` 的 `signOut` 改为 `signOut` from `next-auth/react`
- 修改 `apps/nextjs/src/components/navbar.tsx`，将登录链接从 `/login-clerk` 改为 `/login`
- 修改 `apps/nextjs/src/components/modal-provider.tsx`，从 `SignInClerkModal` 改为 `SignInModal`

### 6. 更新页面路由
- 修改 `apps/nextjs/src/app/[lang]/(auth)/login-clerk/[[...rest]]/page.tsx`，改为使用 NextAuth 的登录表单
- 或创建新的 `/login` 路由，复用已有的 `sign-in-modal.tsx`

### 7. 清理 Clerk 相关代码
- 删除或注释掉 Clerk 专用组件：
  - `user-clerk-auth-form.tsx`
  - `sign-in-modal-clerk.tsx`
- 从 `package.json` 中移除 `@clerk/nextjs` 依赖

### 8. 环境变量配置
- 确保 `.env.local` 中的 NextAuth 配置正确：
  - `NEXTAUTH_URL`
  - `NEXTAUTH_SECRET`
  - `GITHUB_CLIENT_ID`
  - `GITHUB_CLIENT_SECRET`

## 优势
- 项目已有 NextAuth 基础代码，迁移工作量较小
- NextAuth 更灵活，易于自定义
- 减少第三方依赖